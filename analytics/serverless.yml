
frameworkVersion: '3'

functions:
  api:
    events:
      - httpApi: 'GET /'
    image:
      uri: ${aws:accountId}.dkr.ecr.${aws:region}.amazonaws.com/wheelerrecommends-scraper-analytics:${param:sha}
    memorySize: 2048
    timeout: 28

package:
  exclude:
    - venv/**

provider:
  name: aws
  iamRoleStatements:
    - Effect: Allow
      Action:
        - 'athena:GetDatabase'
        - 'athena:GetDataCatalog'
        - 'athena:GetQueryExecution'
        - 'athena:GetQueryResults'
        - 'athena:GetQueryResultsStream'
        - 'athena:GetTable'
        - 'athena:GetTableMetadata'
        - 'athena:GetWorkGroup'
        - 'athena:StartQueryExecution'
        - 'athena:StopQueryExecution'
      Resource: '*'
    - Effect: Allow
      Action:
        - 'glue:GetDatabase'
        - 'glue:GetTable'
        - 'glue:GetPartition'
        - 'glue:GetPartitions'
      Resource:
        - 'arn:aws:glue:us-east-1:123456789012:catalog'
        - 'arn:aws:glue:us-east-1:123456789012:database/wheelerrecommends-scraper-database'
        - 'arn:aws:glue:us-east-1:123456789012:table/wheelerrecommends-scraper-database/home_page'
        - 'arn:aws:glue:us-east-1:123456789012:table/wheelerrecommends-scraper-database/movie_details_page'
    - Effect: Allow
      Action:
        - 's3:GetBucketLocation'
        - 's3:ListBucket'
        - 's3:GetObject'
      Resource:
        - 'arn:aws:s3:::wheelerrecommends-scraper-data/*'
        - 'arn:aws:s3:::wheelerrecommends-scraper-data'
    - Effect: Allow
      Action:
        - 's3:GetBucketLocation'
        - 's3:ListBucket'
        - 's3:GetObject'
        - 's3:PutObject'
      Resource:
        - 'arn:aws:s3:::wheelerrecommends-scraper-logs/*'
        - 'arn:aws:s3:::wheelerrecommends-scraper-logs'

service: wheelerrecommends-scraper-analytics
